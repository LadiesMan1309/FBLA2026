// Lesson Content Database
window.lessonContent = {
    'intro': {
        content: `
            <h2>Introduction to Physics</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/b1t41Q3xRM8" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <p>Physics is the study of matter, energy, and the fundamental forces of nature. In this course, you'll explore the basic principles that govern our universe.</p>
        `
    },
    'lesson1': {
        content: `
            <h2>Lesson 1: Measurement and Units</h2>
            <h3>Key Concepts:</h3>
            <ul>
                <li><strong>SI Units:</strong> The International System of Units (meters, kilograms, seconds)</li>
                <li><strong>Length:</strong> Measured in meters (m)</li>
                <li><strong>Mass:</strong> Measured in kilograms (kg)</li>
                <li><strong>Time:</strong> Measured in seconds (s)</li>
                <li><strong>Precision and Accuracy:</strong> Understanding measurement quality</li>
            </ul>
        `
    },
    'lesson2': {
        content: `
            <h2>Lesson 2: Motion (Speed, Velocity, Acceleration)</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/ZM8ECpBuQYE" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <h3>Key Concepts:</h3>
            <ul>
                <li><strong>Speed:</strong> Distance traveled per unit time (scalar)</li>
                <li><strong>Velocity:</strong> Speed with direction (vector)</li>
                <li><strong>Acceleration:</strong> Change in velocity over time</li>
                <li><strong>Formula:</strong> v = d/t (velocity = distance/time)</li>
            </ul>
        `
    },
    'lesson3': {
        content: `
            <h2>Lesson 3: Force and Laws of Motion</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/kKKM8Y-u7ds" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <h3>Newton's Three Laws:</h3>
            <ul>
                <li><strong>First Law:</strong> An object at rest stays at rest (Inertia)</li>
                <li><strong>Second Law:</strong> F = ma (Force = mass × acceleration)</li>
                <li><strong>Third Law:</strong> For every action, there's an equal and opposite reaction</li>
            </ul>
        `
    },
    'lesson4': {
        content: `
            <h2>Lesson 4: Work, Energy, and Power</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/w4QFJb9a8vo" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <h3>Key Concepts:</h3>
            <ul>
                <li><strong>Work:</strong> W = F × d (force × distance)</li>
                <li><strong>Kinetic Energy:</strong> Energy of motion (KE = ½mv²)</li>
                <li><strong>Potential Energy:</strong> Stored energy (PE = mgh)</li>
                <li><strong>Power:</strong> Rate of doing work (P = W/t)</li>
            </ul>
        `
    },
    'lesson5': {
        content: `
            <h2>Lesson 5: Gravity</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/7gf6YpdvtE0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <h3>Key Concepts:</h3>
            <ul>
                <li><strong>Gravitational Force:</strong> Attraction between objects with mass</li>
                <li><strong>Weight:</strong> W = mg (mass × gravity)</li>
                <li><strong>Acceleration due to gravity:</strong> g = 9.8 m/s² on Earth</li>
                <li><strong>Free Fall:</strong> Motion under gravity alone</li>
            </ul>
        `
    },
    'lesson6': {
        content: `
            <h2>Lesson 6: Heat and Temperature</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/vqDbMEdLiCs" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <h3>What is Temperature?</h3>
            <p>Temperature measures how fast particles in a substance are moving. The faster they move, the higher the temperature. We measure temperature in degrees Celsius (°C), Fahrenheit (°F), or Kelvin (K).</p>

            <h3>What is Heat?</h3>
            <p>Heat is the transfer of thermal energy from a warmer object to a cooler one. When you touch a hot stove, heat transfers from the stove to your hand.</p>

            <h3>Three Ways Heat Transfers:</h3>
            <ul>
                <li><strong>Conduction:</strong> Heat transfer through direct contact. Example: A metal spoon gets hot in a cup of tea.</li>
                <li><strong>Convection:</strong> Heat transfer through fluid movement (liquids or gases). Example: Warm air rises, cool air sinks, creating wind.</li>
                <li><strong>Radiation:</strong> Heat transfer through electromagnetic waves. Example: The sun warms Earth without touching it.</li>
            </ul>

            <h3>Real-World Examples:</h3>
            <p>• Your home heater uses convection to warm the air<br>
            • Ice melts in your hand due to conduction<br>
            • The sun's rays warm your skin through radiation</p>
        `
    },
    'lesson7': {
        content: `
            <h2>Lesson 7: Light (Reflection and Refraction)</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/IRBfpBPELmE" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <h3>What is Light?</h3>
            <p>Light is electromagnetic radiation that our eyes can see. It travels in straight lines at incredibly fast speeds - about 300,000 km/s!</p>

            <h3>Reflection</h3>
            <p>When light bounces off a surface, that's reflection. Mirrors reflect light, which is why you can see yourself. The Law of Reflection states: the angle at which light hits a surface equals the angle at which it bounces off.</p>

            <h3>Refraction</h3>
            <p>When light passes from one material to another (like from air to water), it bends. This is refraction. That's why a straw looks bent in a glass of water!</p>

            <h3>Lenses</h3>
            <ul>
                <li><strong>Convex Lenses:</strong> Curved outward, make things look bigger (magnifying glass)</li>
                <li><strong>Concave Lenses:</strong> Curved inward, make things look smaller</li>
            </ul>

            <h3>Real-World Uses:</h3>
            <p>• Eyeglasses and contact lenses correct vision<br>
            • Cameras use lenses to focus light<br>
            • Telescopes use mirrors and lenses to see distant objects</p>
        `
    },
    'lesson8': {
        content: `
            <h2>Lesson 8: Sound</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/TsQL4gRYRMM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <h3>How Sound Works</h3>
            <p>Sound is created by vibrations that travel through air, water, or solids as waves. When you speak, your vocal cords vibrate, creating sound waves that travel through the air to someone's ears.</p>

            <h3>Properties of Sound:</h3>
            <ul>
                <li><strong>Frequency:</strong> How many vibrations happen per second (measured in Hertz/Hz). High frequency = high pitch (like a whistle). Low frequency = low pitch (like a drum).</li>
                <li><strong>Amplitude:</strong> The height of the wave. Larger amplitude = louder sound. Smaller amplitude = quieter sound.</li>
                <li><strong>Speed:</strong> Sound travels at about 343 m/s in air (faster in water and solids!)</li>
            </ul>

            <h3>Echo</h3>
            <p>An echo happens when sound waves bounce off a surface and come back to you. That's why you hear echoes in tunnels or canyons!</p>

            <h3>Real-World Applications:</h3>
            <p>• Musical instruments create different frequencies to make music<br>
            • Ultrasound uses high-frequency sound to see inside the body<br>
            • Sonar uses sound waves to detect objects underwater</p>
        `
    },
    'lesson9': {
        content: `
            <h2>Lesson 9: Electricity (Current, Voltage, Circuits)</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/mc979OhitAg" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <h3>Understanding Electricity</h3>
            <p>Electricity is the flow of tiny particles called electrons through a material. Think of it like water flowing through pipes!</p>

            <h3>Three Important Concepts:</h3>
            <ul>
                <li><strong>Current (I):</strong> The flow of electric charge, measured in Amperes (A). Like how much water flows through a pipe.</li>
                <li><strong>Voltage (V):</strong> The electrical pressure that pushes electrons, measured in Volts (V). Like water pressure in pipes.</li>
                <li><strong>Resistance (R):</strong> How much a material opposes the flow of electricity, measured in Ohms (Ω). Like friction in a pipe.</li>
            </ul>

            <h3>Ohm's Law</h3>
            <p>The relationship between voltage, current, and resistance: <strong>V = I × R</strong></p>
            <p>This means: Voltage = Current × Resistance</p>

            <h3>Types of Circuits:</h3>
            <ul>
                <li><strong>Series Circuit:</strong> Components connected in a single path. If one breaks, all stop working (like old Christmas lights).</li>
                <li><strong>Parallel Circuit:</strong> Components connected in multiple paths. If one breaks, others keep working (like house lights).</li>
            </ul>

            <h3>Real-Life Uses:</h3>
            <p>• All electronic devices (phones, computers, TVs)<br>
            • Home wiring and lighting<br>
            • Electric cars and batteries</p>
        `
    },
    'lesson10': {
        content: `
            <h2>Lesson 10: Magnetism</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/hFAOXdXZ5TM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <h3>What is Magnetism?</h3>
            <p>Magnetism is an invisible force that can attract or repel certain materials, especially iron. Magnets have been used for thousands of years!</p>

            <h3>Magnetic Poles</h3>
            <p>Every magnet has two poles: North and South</p>
            <ul>
                <li><strong>Opposite poles attract:</strong> North and South pull together</li>
                <li><strong>Same poles repel:</strong> North and North (or South and South) push apart</li>
            </ul>

            <h3>Magnetic Fields</h3>
            <p>The area around a magnet where magnetic forces can be felt is called a magnetic field. Iron filings can show you the pattern of a magnetic field!</p>

            <h3>Electromagnets</h3>
            <p>You can create a magnet using electricity! When electric current flows through a wire coil, it creates a magnetic field. This is called an electromagnet, and it can be turned on and off.</p>

            <h3>Real-World Applications:</h3>
            <p>• Electric motors and generators<br>
            • Speakers and headphones<br>
            • MRI machines in hospitals<br>
            • Compasses for navigation<br>
            • Hard drives and credit card strips</p>
        `
    },
    'lesson11': {
        content: `
            <h2>Lesson 11: Simple Machines</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/qRXM97eVRFo" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <h3>What are Simple Machines?</h3>
            <p>Simple machines are basic tools that make work easier. They help us lift heavy objects, move things farther, or apply more force with less effort.</p>

            <h3>The Six Simple Machines:</h3>

            <h4>1. Lever</h4>
            <p>A rigid bar that pivots on a fulcrum (pivot point). Example: Seesaw, crowbar, scissors. Using a long lever, you can lift heavy objects with less force!</p>

            <h4>2. Wheel and Axle</h4>
            <p>A wheel attached to a rod (axle) that turns together. Example: Doorknobs, bicycle wheels, car steering wheels. Makes it easier to move things or turn objects.</p>

            <h4>3. Pulley</h4>
            <p>A wheel with a rope or cable around it for lifting. Example: Flagpoles, construction cranes. Pulleys let you lift heavy objects by pulling down instead of up!</p>

            <h4>4. Inclined Plane</h4>
            <p>A flat surface set at an angle (like a ramp). Example: Wheelchair ramps, roads up mountains. It's easier to push something up a ramp than to lift it straight up.</p>

            <h4>5. Wedge</h4>
            <p>Two inclined planes put together to form a sharp edge. Example: Knife, axe, doorstop. Wedges split things apart or hold them in place.</p>

            <h4>6. Screw</h4>
            <p>An inclined plane wrapped around a cylinder. Example: Screws, bolts, jar lids. Screws hold things together very tightly.</p>

            <h3>Why Simple Machines Matter:</h3>
            <p>All complex machines (like cars, computers, and robots) are made by combining these six simple machines! Understanding them helps you understand how everything works.</p>
        `
    },
    'lesson12': {
        content: `
            <h2>Lesson 12: Physics in Daily Life</h2>
            <div class="video-container">
                <iframe width="100%" height="400" src="https://www.youtube.com/embed/Cj4y0EUlU-Y" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <h3>Physics is Everywhere!</h3>
            <p>Everything you do involves physics! Let's explore how physics concepts show up in your daily life.</p>

            <h3>Transportation</h3>
            <p><strong>Cars:</strong> Use friction (brakes), force and acceleration (engine), and aerodynamics (shape to reduce air resistance).</p>
            <p><strong>Airplanes:</strong> Fly using lift (air pressure differences), thrust (engines), and drag (air resistance).</p>
            <p><strong>Bicycles:</strong> Use wheels and axles (simple machines), gears (mechanical advantage), and balance (center of gravity).</p>

            <h3>Communication</h3>
            <p><strong>Smartphones:</strong> Use electromagnetic waves to send and receive signals, touchscreens work with electrical charges, and speakers use electromagnets to create sound.</p>
            <p><strong>WiFi & Radio:</strong> Invisible electromagnetic waves carry information through the air at the speed of light!</p>

            <h3>Medicine</h3>
            <p><strong>X-rays:</strong> Use high-energy electromagnetic radiation to see inside your body.</p>
            <p><strong>MRI:</strong> Uses powerful magnets and radio waves to create detailed images of organs.</p>
            <p><strong>Ultrasound:</strong> Uses sound waves to see babies before they're born!</p>

            <h3>Sports</h3>
            <p><strong>Basketball:</strong> Projectile motion determines the arc of your shot.</p>
            <p><strong>Swimming:</strong> You push water backward (action) and move forward (reaction) - Newton's Third Law!</p>
            <p><strong>Running:</strong> Friction between shoes and ground prevents slipping.</p>

            <h3>Home</h3>
            <p><strong>Refrigerator:</strong> Uses thermodynamics to transfer heat out of the fridge.</p>
            <p><strong>Microwave:</strong> Uses electromagnetic waves to heat food.</p>
            <p><strong>Light Bulbs:</strong> Convert electrical energy into light energy.</p>

            <h3>The Big Picture</h3>
            <p>Physics isn't just about formulas and equations - it's about understanding how the world works! Every time you turn on a light, ride a bike, or play a game, you're using physics principles. Understanding physics helps you appreciate technology and solve real-world problems!</p>
        `
    },
    'midterm': {
        type: 'quiz',
        totalQuestions: 10,
        questions: [
            {
                question: "What is the SI unit for measuring length?",
                options: ["Meter", "Kilogram", "Second", "Newton"],
                correct: 0
            },
            {
                question: "Speed is a scalar quantity. What does this mean?",
                options: ["It has both magnitude and direction", "It only has magnitude", "It changes over time", "It is constant"],
                correct: 1
            },
            {
                question: "According to Newton's First Law, an object at rest will:",
                options: ["Eventually start moving", "Stay at rest unless acted upon by a force", "Always accelerate", "Lose mass"],
                correct: 1
            },
            {
                question: "What is the formula for work?",
                options: ["W = m × a", "W = F × d", "W = m × v", "W = F × t"],
                correct: 1
            },
            {
                question: "What is the acceleration due to gravity on Earth?",
                options: ["9.8 m/s", "9.8 m/s²", "10 m/s", "10 m/s²"],
                correct: 1
            },
            {
                question: "Which of the following is NOT a method of heat transfer?",
                options: ["Conduction", "Convection", "Radiation", "Reflection"],
                correct: 3
            },
            {
                question: "What is Newton's Second Law?",
                options: ["F = ma", "E = mc²", "V = IR", "P = W/t"],
                correct: 0
            },
            {
                question: "Velocity is different from speed because velocity includes:",
                options: ["Mass", "Direction", "Time", "Temperature"],
                correct: 1
            },
            {
                question: "Kinetic energy is the energy of:",
                options: ["Position", "Motion", "Heat", "Light"],
                correct: 1
            },
            {
                question: "The weight of an object is calculated using which formula?",
                options: ["W = m × v", "W = m × g", "W = F × d", "W = m × a"],
                correct: 1
            }
        ]
    },
    'finaltest': {
        type: 'quiz',
        totalQuestions: 20,
        questions: [
            {
                question: "What are the three basic SI units?",
                options: ["Meter, Liter, Second", "Meter, Kilogram, Second", "Foot, Pound, Hour", "Inch, Gram, Minute"],
                correct: 1
            },
            {
                question: "If a car travels 100 meters in 5 seconds, what is its speed?",
                options: ["20 m/s", "500 m/s", "5 m/s", "100 m/s"],
                correct: 0
            },
            {
                question: "Newton's Third Law states:",
                options: ["Objects at rest stay at rest", "F = ma", "For every action there is an equal and opposite reaction", "Energy is conserved"],
                correct: 2
            },
            {
                question: "Power is defined as:",
                options: ["Work per unit time", "Force times distance", "Mass times acceleration", "Energy times velocity"],
                correct: 0
            },
            {
                question: "What happens to gravitational force as distance increases?",
                options: ["Increases", "Decreases", "Stays the same", "Becomes zero"],
                correct: 1
            },
            {
                question: "Temperature measures the average _____ of particles:",
                options: ["Potential energy", "Kinetic energy", "Mass", "Velocity"],
                correct: 1
            },
            {
                question: "The law of reflection states that angle of incidence equals:",
                options: ["Angle of refraction", "Angle of reflection", "90 degrees", "0 degrees"],
                correct: 1
            },
            {
                question: "Sound travels through which type of wave?",
                options: ["Transverse", "Longitudinal", "Electromagnetic", "Light"],
                correct: 1
            },
            {
                question: "Ohm's Law is expressed as:",
                options: ["V = IR", "F = ma", "E = mc²", "P = W/t"],
                correct: 0
            },
            {
                question: "Magnets have how many poles?",
                options: ["One", "Two", "Three", "Four"],
                correct: 1
            },
            {
                question: "Which is NOT a simple machine?",
                options: ["Lever", "Pulley", "Engine", "Wedge"],
                correct: 2
            },
            {
                question: "MRI machines use which physics principle?",
                options: ["Gravity", "Magnetism", "Sound", "Light"],
                correct: 1
            },
            {
                question: "Potential energy depends on:",
                options: ["Speed", "Position", "Temperature", "Volume"],
                correct: 1
            },
            {
                question: "Current is measured in:",
                options: ["Volts", "Ohms", "Amperes", "Watts"],
                correct: 2
            },
            {
                question: "What causes refraction?",
                options: ["Light bouncing off surfaces", "Light bending when entering different mediums", "Sound reflection", "Heat transfer"],
                correct: 1
            },
            {
                question: "Frequency of sound is measured in:",
                options: ["Meters", "Seconds", "Hertz", "Watts"],
                correct: 2
            },
            {
                question: "An inclined plane is an example of a:",
                options: ["Complex machine", "Simple machine", "Energy source", "Wave"],
                correct: 1
            },
            {
                question: "Convection occurs in:",
                options: ["Solids only", "Fluids (liquids and gases)", "Vacuum", "Metals only"],
                correct: 1
            },
            {
                question: "Electromagnets are created using:",
                options: ["Permanent magnets", "Electric current", "Heat", "Light"],
                correct: 1
            },
            {
                question: "The speed of sound in air at room temperature is approximately:",
                options: ["343 m/s", "3000 m/s", "100 m/s", "1000 m/s"],
                correct: 0
            }
        ]
    }
};

// Import Firebase Auth functions
import {
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signInWithPopup,
    GoogleAuthProvider,
    signOut,
    onAuthStateChanged,
    updateProfile
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

// Wait for both DOM and Firebase to be ready
let auth;
let googleProvider;

// Authentication State
let isLoggedIn = false;
let userEmail = '';

// DOM elements (will be initialized after DOM loads)
let loginSection;
let signupSection;
let homeSection;
let learnSection;
let physicsCourse;
let scheduleSection;
let dashboardSection;
let resourcesSection;
let sourcesSection;
let settingsSection;
let tutorSection;
let homeBtn;
let scheduleBtn;
let dashboardBtn;
let resourcesBtn;
let learnBtn;
let authBtn;
let navToggleBtn;
let judgeTourBtn;
let previewBadge;
let siteHeader;


// Wait for Firebase to be ready
function waitForFirebase() {
    return new Promise((resolve) => {
        if (window.firebaseAuth) {
            resolve();
        } else {
            const checkInterval = setInterval(() => {
                if (window.firebaseAuth) {
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 50);
        }
    });
}

// Initialize after DOM is loaded
document.addEventListener('DOMContentLoaded', async () => {
    // Wait for Firebase to be ready
    await waitForFirebase();

    // Get Firebase auth instance
    auth = window.firebaseAuth;
    googleProvider = new GoogleAuthProvider();

    // Get sections
    loginSection = document.getElementById('login-section');
    signupSection = document.getElementById('signup-section');
    homeSection = document.getElementById('home-section');
    learnSection = document.getElementById('learn-section');
    physicsCourse = document.getElementById('physics-course');
    scheduleSection = document.getElementById('schedule-section');
    dashboardSection = document.getElementById('dashboard-section');
    resourcesSection = document.getElementById('resources-section');
    sourcesSection = document.getElementById('sources-section');
    settingsSection = document.getElementById('settings-section');
    tutorSection = document.getElementById('tutor-section');

    // Get navigation buttons
    homeBtn = document.getElementById('home-btn');
    scheduleBtn = document.getElementById('schedule-btn');
    dashboardBtn = document.getElementById('dashboard-btn');
    resourcesBtn = document.getElementById('resources-btn');
    learnBtn = document.getElementById('learn-btn');
    authBtn = document.getElementById('auth-btn');

    navToggleBtn = document.getElementById('nav-toggle');
    judgeTourBtn = document.getElementById('judge-tour-btn');
    previewBadge = document.getElementById('preview-badge');
    siteHeader = document.getElementById('site-header');

    // Initialize all event listeners
    console.log('DOM loaded, Firebase ready, initializing...');
    initializeEventListeners();
    initTestimonialsTicker();
    initSchoolhouseNav();
    console.log('Initialization complete');
});

// Show/hide sections
function hideAllSections() {
    loginSection.style.display = 'none';
    signupSection.style.display = 'none';
    homeSection.style.display = 'none';
    learnSection.style.display = 'none';
    physicsCourse.style.display = 'none';
    scheduleSection.style.display = 'none';
    dashboardSection.style.display = 'none';
    resourcesSection.style.display = 'none';
    sourcesSection.style.display = 'none';
    settingsSection.style.display = 'none';
    tutorSection.style.display = 'none';
}

function showLogin() {
    hideAllSections();
    loginSection.style.display = 'flex';
    setActiveNav('auth-btn');
}

function showSignup() {
    hideAllSections();
    signupSection.style.display = 'flex';
}

function showHome() {
    hideAllSections();
    homeSection.style.display = 'block';
    setActiveNav('home-btn');
}

function showLearn() {
    if (!isLoggedIn && !isPreviewMode()) {
        showLogin();
        return;
    }
    hideAllSections();
    learnSection.style.display = 'flex';
    setActiveNav('learn-btn');
}

function showSchedule() {
    if (!isLoggedIn) {
        alert('Immersive LFA wants you to login first to access the schedule');
        showLogin();
        return;
    }
    hideAllSections();
    scheduleSection.style.display = 'flex';
    loadUserBookings();
}

function showDashboard() {
    if (!isLoggedIn && !isPreviewMode()) {
        alert('Immersive LFA wants you to login first to access your dashboard');
        showLogin();
        return;
    }
    hideAllSections();
    dashboardSection.style.display = 'flex';
    setActiveNav('dashboard-btn');
    if (isLoggedIn) updateDashboard();
}

function showResources() {
    if (!isLoggedIn && !isPreviewMode()) {
        alert('Immersive LFA wants you to login first to access resources');
        showLogin();
        return;
    }
    hideAllSections();
    resourcesSection.style.display = 'flex';
    setActiveNav('resources-btn');
}

function showSettings() {
    if (!isLoggedIn && !isPreviewMode()) {
        alert('Immersive LFA wants you to login first to access settings');
        showLogin();
        return;
    }
    hideAllSections();
    settingsSection.style.display = 'flex';
    setActiveNav('settings-btn');
    loadUserSettings();
}

function showTutor() {
    hideAllSections();
    tutorSection.style.display = 'flex';
    setActiveNav('tutor-btn');
}

function initializeEventListeners() {
    console.log('Initializing event listeners...');

    // Navigation event listeners
    homeBtn.addEventListener('click', () => {
        console.log('Home button clicked');
        showHome();
    });

    scheduleBtn.addEventListener('click', () => {
        showSchedule();
    });

    dashboardBtn.addEventListener('click', () => {
        showDashboard();
    });

    resourcesBtn.addEventListener('click', () => {
        showResources();
    });

    learnBtn.addEventListener('click', () => {
        if (!isLoggedIn) {
            alert('Immersive LFA wants you to login first to access courses');
            showLogin();
            return;
        }
        showLearn();
    });

    const tutorBtn = document.getElementById('tutor-btn');
    if (tutorBtn) {
        tutorBtn.addEventListener('click', () => {
            showTutor();
        });
    }

    authBtn.addEventListener('click', async () => {
        console.log('Auth button clicked, isLoggedIn:', isLoggedIn);
        if (isLoggedIn) {
            // Logout
            try {
                await signOut(auth);
                // Redirect to homepage after logout
                showHome();
            } catch (error) {
                console.error('Logout error:', error);
            }
        } else {
            // Show login
            console.log('Showing login page');
            showLogin();
        }
    });

    // Settings button
    const settingsBtn = document.getElementById('settings-btn');
    if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
            showSettings();
        });
    }

    // Save profile button
    const saveProfileBtn = document.getElementById('save-profile-btn');
    if (saveProfileBtn) {
        saveProfileBtn.addEventListener('click', () => {
            saveUserSettings();
        });
    }

    // Reset progress button
    const resetProgressBtn = document.getElementById('reset-progress-btn');
    if (resetProgressBtn) {
        resetProgressBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all your course progress? This action cannot be undone.')) {
                resetCourseProgress();
            }
        });
    }

    // Delete account button
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone and all your data will be permanently removed.')) {
                deleteUserAccount();
            }
        });
    }

// Logo click to return home (safe)
const logo =
  document.getElementById('brand-link') ||
  document.querySelector('.logo') ||
  document.querySelector('.sh-nav__brand');

if (logo) {
  logo.addEventListener('click', (e) => {
    e.preventDefault();
    showHome();
  });
  logo.style.cursor = 'pointer';
}



    // Google Login
    document.getElementById('google-login').addEventListener('click', async () => {
        try {
            const result = await signInWithPopup(auth, googleProvider);
            const user = result.user;
            console.log('Logged in:', user.email);
            showHome();
        } catch (error) {
            console.error('Google login error:', error);
            alert('Immersive LFA: Google login failed - ' + error.message);
        }
    });

    // Email Login
    document.getElementById('email-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
            await signInWithEmailAndPassword(auth, email, password);
            showHome();
        } catch (error) {
            console.error('Login error:', error);
            if (error.code === 'auth/user-not-found') {
                alert('Immersive LFA: No account found with this email. Please sign up first!');
            } else if (error.code === 'auth/wrong-password') {
                alert('Immersive LFA: Incorrect password. Please try again!');
            } else if (error.code === 'auth/invalid-credential') {
                alert('Immersive LFA: Invalid email or password. Please try again!');
            } else {
                alert('Immersive LFA: Login failed - ' + error.message);
            }
        }
    });

    // Signup link
    document.getElementById('signup-link').addEventListener('click', (e) => {
        e.preventDefault();
        showSignup();
    });

    // Login link (from signup page)
    document.getElementById('login-link').addEventListener('click', (e) => {
        e.preventDefault();
        showLogin();
    });

    // Google Signup
    document.getElementById('google-signup').addEventListener('click', async () => {
        try {
            const result = await signInWithPopup(auth, googleProvider);
            const user = result.user;
            console.log('Signed up:', user.email);
            showHome();
        } catch (error) {
            console.error('Google signup error:', error);
            alert('Immersive LFA: Google signup failed - ' + error.message);
        }
    });

    // Email Signup
    document.getElementById('email-signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;

        // Client-side validation
        if (password !== confirmPassword) {
            alert('Immersive LFA: Passwords do not match!');
            return;
        }

        if (password.length < 6) {
            alert('Immersive LFA: Password must be at least 6 characters long!');
            return;
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            // Update profile with name
            await updateProfile(userCredential.user, { displayName: name });
            alert('Immersive LFA: Account created successfully!');
            showHome();
        } catch (error) {
            console.error('Signup error:', error);
            if (error.code === 'auth/email-already-in-use') {
                alert('Immersive LFA: An account with this email already exists!');
            } else if (error.code === 'auth/weak-password') {
                alert('Immersive LFA: Password is too weak. Please use a stronger password.');
            } else {
                alert('Immersive LFA: Signup failed - ' + error.message);
            }
        }
    });

    // Handle course card clicks
    const courseCards = document.querySelectorAll('.course-card');
    courseCards.forEach(card => {
        card.addEventListener('click', () => {
            const course = card.getAttribute('data-course');
            if (course === 'physics') {
                hideAllSections();
                physicsCourse.style.display = 'flex';
                loadLessonProgress();
                loadConfidenceBar();
            }
        });
    });

    // Handle lesson clicks
    const lessonItems = document.querySelectorAll('.lesson-item');
    const lessonContent = document.getElementById('lesson-content');

    lessonItems.forEach(item => {
        item.addEventListener('click', () => {
            const lesson = item.getAttribute('data-lesson');

            // Remove active class from all lessons
            lessonItems.forEach(l => l.classList.remove('active'));
            // Add active class to clicked lesson
            item.classList.add('active');

            // Load lesson content from global lessonContent object
            if (window.lessonContent && window.lessonContent[lesson]) {
                const content = window.lessonContent[lesson];

                // Check if this is a quiz
                if (content.type === 'quiz') {
                    renderQuiz(lesson, content);
                } else {
                    lessonContent.innerHTML = content.content +
                        `<button class="complete-lesson-btn" onclick="markComplete('${lesson}')">Mark as Complete</button>`;
                }
            } else {
                lessonContent.innerHTML = `
                    <h2>${item.textContent}</h2>
                    <p>Lesson content will be displayed here.</p>
                    <button class="complete-lesson-btn" onclick="markComplete('${lesson}')">Mark as Complete</button>
                `;
            }
        });
    });

    // Schedule tabs
    const privateTab = document.getElementById('private-tab');
    const groupTab = document.getElementById('group-tab');
    const privateContent = document.getElementById('private-content');
    const groupContent = document.getElementById('group-content');

    if (privateTab && groupTab) {
        privateTab.addEventListener('click', () => {
            privateTab.classList.add('active');
            groupTab.classList.remove('active');
            privateContent.classList.add('active');
            groupContent.classList.remove('active');
        });

        groupTab.addEventListener('click', () => {
            groupTab.classList.add('active');
            privateTab.classList.remove('active');
            groupContent.classList.add('active');
            privateContent.classList.remove('active');
        });
    }

    // Resources tabs
    const resourceTabs = document.querySelectorAll('.resource-tab');
    const resourceContents = document.querySelectorAll('.resource-content');

    resourceTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetResource = tab.getAttribute('data-resource');
            
            resourceTabs.forEach(t => t.classList.remove('active'));
            resourceContents.forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            const targetContent = document.getElementById(targetResource + '-content');
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    });

    // Booking form submission
    document.getElementById('booking-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const subject = document.getElementById('booking-subject').value;
        const date = document.getElementById('booking-date').value;
        const time = document.getElementById('booking-time').value;
        const duration = document.getElementById('booking-duration').value;
        const notes = document.getElementById('booking-notes').value;

        const booking = {
            id: Date.now().toString(),
            subject: subject,
            date: date,
            time: time,
            duration: duration,
            notes: notes,
            createdAt: new Date().toISOString()
        };

        saveBooking(booking);

        // Send confirmation email
        await sendBookingEmail(booking);

        // Clear form
        document.getElementById('booking-form').reset();

        // Reload bookings list
        loadUserBookings();

        alert('Immersive LFA: Session booked successfully! We will confirm your booking via email.');
    });

    // Firebase Auth State Observer
    onAuthStateChanged(auth, (user) => {
        if (user) {
            isLoggedIn = true;
            userEmail = user.email;
            authBtn.textContent = 'Logout';
            homeBtn.style.display = 'block';
            scheduleBtn.style.display = 'block';
            learnBtn.style.display = 'block';
            console.log('User logged in:', userEmail);

            // Reload lesson progress if on physics course page
            if (physicsCourse && physicsCourse.style.display === 'flex') {
                loadLessonProgress();
            }
            
            // Update dashboard if visible
            if (dashboardSection && dashboardSection.style.display === 'flex') {
                updateDashboard();
            }
        } else {
            isLoggedIn = false;
            userEmail = '';
            authBtn.textContent = 'Login';
            homeBtn.style.display = 'block';
            scheduleBtn.style.display = 'block';
            learnBtn.style.display = 'block';
            console.log('User logged out');

            // Clear lesson progress display when logged out
            const lessonItems = document.querySelectorAll('.lesson-item');
            lessonItems.forEach(item => {
                item.classList.remove('completed');
            });
        }

        // Show home page by default if no other section is visible
        const visibleSections = [
            loginSection, signupSection, homeSection, learnSection, 
            physicsCourse, scheduleSection, dashboardSection, resourcesSection, sourcesSection
        ].filter(section => section && (section.style.display === 'flex' || section.style.display === 'block'));
        
        if (visibleSections.length === 0) {
            showHome();
        }
    });
    // Schoolhouse-inspired navbar interactions
    if (navToggleBtn && siteHeader) {
        navToggleBtn.addEventListener('click', () => toggleMobileNav());
    }
    if (judgeTourBtn) {
        judgeTourBtn.addEventListener('click', () => startOrToggleJudgeTour());
    }

}

// Lesson Progress Tracking (user-specific)
function getLessonProgress() {
    const userId = auth.currentUser?.uid || 'anonymous';
    const key = `lessonProgress_${userId}`;
    const progress = localStorage.getItem(key);
    return progress ? JSON.parse(progress) : {};
}

function saveLessonProgress(lessonId) {
    const userId = auth.currentUser?.uid || 'anonymous';
    const key = `lessonProgress_${userId}`;
    const progress = getLessonProgress();
    progress[lessonId] = true;
    localStorage.setItem(key, JSON.stringify(progress));
}

function loadLessonProgress() {
    const progress = getLessonProgress();
    const lessonItems = document.querySelectorAll('.lesson-item');

    // First, clear all completed status
    lessonItems.forEach(item => {
        item.classList.remove('completed');
    });

    // Then, load the current user's progress
    lessonItems.forEach(item => {
        const lessonId = item.getAttribute('data-lesson');
        if (progress[lessonId]) {
            item.classList.add('completed');
        }
    });
}

// Make markComplete globally accessible for onclick handlers
window.markComplete = function(lessonId) {
    saveLessonProgress(lessonId);

    // Find the lesson item and mark it as completed
    const lessonItems = document.querySelectorAll('.lesson-item');
    lessonItems.forEach(item => {
        if (item.getAttribute('data-lesson') === lessonId) {
            item.classList.add('completed');
        }
    });

    // Update dashboard if it's visible
    if (dashboardSection && dashboardSection.style.display === 'flex') {
        updateDashboard();
    }

    alert('Immersive LFA: Lesson marked as complete!');
}

// Quiz Rendering and Confidence Tracking
function renderQuiz(quizId, quizData) {
    const lessonContent = document.getElementById('lesson-content');
    const quizName = quizId === 'midterm' ? 'Midterm Quiz' : 'Final Test';
    const questionsCount = quizData.totalQuestions;

    let quizHTML = `
        <h2>${quizName}</h2>
        <p>Test your knowledge with ${questionsCount} questions. You need 80% or higher to proceed confidently.</p>
        <div class="quiz-container" id="quiz-${quizId}">
    `;

    quizData.questions.forEach((q, index) => {
        quizHTML += `
            <div class="quiz-question">
                <p class="question-text"><strong>Question ${index + 1}:</strong> ${q.question}</p>
                <div class="quiz-options">
        `;

        q.options.forEach((option, optIndex) => {
            quizHTML += `
                <label class="quiz-option">
                    <input type="radio" name="q${index}" value="${optIndex}" data-correct="${q.correct}">
                    <span>${option}</span>
                </label>
            `;
        });

        quizHTML += `
                </div>
            </div>
        `;
    });

    quizHTML += `
        </div>
        <button class="submit-quiz-btn" onclick="submitQuiz('${quizId}', ${questionsCount})">Submit ${quizName}</button>
        <div class="quiz-result" id="quiz-result-${quizId}" style="display: none;"></div>
    `;

    lessonContent.innerHTML = quizHTML;
}

window.submitQuiz = function(quizId, totalQuestions) {
    const quizContainer = document.getElementById(`quiz-${quizId}`);
    const resultDiv = document.getElementById(`quiz-result-${quizId}`);

    let correctAnswers = 0;
    const questions = quizContainer.querySelectorAll('.quiz-question');

    questions.forEach((question, index) => {
        const selected = question.querySelector(`input[name="q${index}"]:checked`);
        if (selected) {
            const correctAnswer = parseInt(selected.getAttribute('data-correct'));
            const selectedAnswer = parseInt(selected.value);

            if (selectedAnswer === correctAnswer) {
                correctAnswers++;
                question.style.borderLeft = '4px solid #28a745';
            } else {
                question.style.borderLeft = '4px solid #dc3545';
            }
        } else {
            question.style.borderLeft = '4px solid #dc3545';
        }
    });

    const percentage = Math.round((correctAnswers / totalQuestions) * 100);
    const passed = percentage >= 80;

    // Save quiz score
    saveQuizScore(quizId, correctAnswers, totalQuestions, percentage);

    // Update confidence bar
    updateConfidenceBar();

    resultDiv.style.display = 'block';
    resultDiv.className = passed ? 'quiz-result success' : 'quiz-result warning';
    resultDiv.innerHTML = `
        <h3>${passed ? '✅ Great Job!' : '⚠️ Need More Practice'}</h3>
        <p>You scored ${correctAnswers} out of ${totalQuestions} (${percentage}%)</p>
        <p>${passed ? '<strong>Good to go!</strong> You\'re ready to continue.' : '<strong>⚠️ Do not recommend further procedure until more correct.</strong> Review the lessons and try again.'}</p>
        <button class="complete-lesson-btn" onclick="markComplete('${quizId}')">Mark as Complete</button>
    `;

    // Scroll to result
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
};

function saveQuizScore(quizId, correct, total, percentage) {
    const userId = auth.currentUser?.uid || 'anonymous';
    const key = `quizScores_${userId}`;

    let scores = {};
    const stored = localStorage.getItem(key);
    if (stored) {
        scores = JSON.parse(stored);
    }

    scores[quizId] = {
        correct,
        total,
        percentage,
        date: new Date().toISOString()
    };

    localStorage.setItem(key, JSON.stringify(scores));

    // Update score display
    const scoreElement = document.getElementById(`${quizId}-score`);
    if (scoreElement) {
        scoreElement.textContent = `${correct}/${total} (${percentage}%)`;
    }
}

function updateConfidenceBar() {
    const userId = auth.currentUser?.uid || 'anonymous';
    const key = `quizScores_${userId}`;
    const stored = localStorage.getItem(key);

    if (!stored) {
        return;
    }

    const scores = JSON.parse(stored);
    const quizScores = Object.values(scores);

    if (quizScores.length === 0) {
        return;
    }

    // Calculate average percentage
    const totalPercentage = quizScores.reduce((sum, score) => sum + score.percentage, 0);
    const averagePercentage = Math.round(totalPercentage / quizScores.length);

    const confidenceFill = document.getElementById('confidence-fill');
    const confidencePercentage = document.getElementById('confidence-percentage');
    const confidenceStatus = document.getElementById('confidence-status');

    if (confidenceFill && confidencePercentage && confidenceStatus) {
        confidenceFill.style.width = `${averagePercentage}%`;

        // Change color based on percentage
        if (averagePercentage >= 80) {
            confidenceFill.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
        } else if (averagePercentage >= 60) {
            confidenceFill.style.background = 'linear-gradient(90deg, #ffc107, #fd7e14)';
        } else {
            confidenceFill.style.background = 'linear-gradient(90deg, #dc3545, #c82333)';
        }

        confidencePercentage.textContent = `${averagePercentage}%`;

        if (averagePercentage >= 80) {
            confidenceStatus.innerHTML = '<strong>✅ Good to go!</strong><br>You\'re ready to continue.';
            confidenceStatus.style.color = '#28a745';
        } else {
            confidenceStatus.innerHTML = '<strong>⚠️ Recommend not to go further</strong><br>Review lessons and improve scores.';
            confidenceStatus.style.color = '#dc3545';
        }
    }
}

// Load confidence on page load
function loadConfidenceBar() {
    const userId = auth.currentUser?.uid || 'anonymous';
    const key = `quizScores_${userId}`;
    const stored = localStorage.getItem(key);

    if (!stored) {
        return;
    }

    const scores = JSON.parse(stored);

    // Update score displays
    if (scores.midterm) {
        const midtermScore = document.getElementById('midterm-score');
        if (midtermScore) {
            midtermScore.textContent = `${scores.midterm.correct}/${scores.midterm.total} (${scores.midterm.percentage}%)`;
        }
    }

    if (scores.finaltest) {
        const finalScore = document.getElementById('final-score');
        if (finalScore) {
            finalScore.textContent = `${scores.finaltest.correct}/${scores.finaltest.total} (${scores.finaltest.percentage}%)`;
        }
    }

    updateConfidenceBar();
}

// Booking Management Functions
function getUserBookings() {
    const userId = auth.currentUser?.uid || 'anonymous';
    const key = `bookings_${userId}`;
    const bookings = localStorage.getItem(key);
    return bookings ? JSON.parse(bookings) : [];
}

function saveBooking(booking) {
    const bookings = getUserBookings();
    bookings.push(booking);

    const userId = auth.currentUser?.uid || 'anonymous';
    const key = `bookings_${userId}`;
    localStorage.setItem(key, JSON.stringify(bookings));
}

function deleteBooking(bookingId) {
    let bookings = getUserBookings();
    bookings = bookings.filter(b => b.id !== bookingId);

    const userId = auth.currentUser?.uid || 'anonymous';
    const key = `bookings_${userId}`;
    localStorage.setItem(key, JSON.stringify(bookings));
}

function loadUserBookings() {
    const bookings = getUserBookings();
    const bookingsList = document.getElementById('bookings-list');

    if (!bookingsList) {
        console.error('Bookings list element not found');
        return;
    }

    if (bookings.length === 0) {
        bookingsList.innerHTML = '<p class="no-bookings">No upcoming sessions scheduled</p>';
        return;
    }

    // Sort bookings by date and time
    bookings.sort((a, b) => {
        const dateA = new Date(a.date + ' ' + a.time);
        const dateB = new Date(b.date + ' ' + b.time);
        return dateA - dateB;
    });

    bookingsList.innerHTML = bookings.map(booking => {
        const subjectNames = {
            'physics': 'Physics 1',
            'other': 'Other',
            'group-study': 'Group Study Session'
        };

        const formattedDate = new Date(booking.date).toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        const formattedTime = formatTime(booking.time);
        
        // For group sessions, show the title; for private sessions, show subject name
        const displayTitle = booking.type === 'group' 
            ? (booking.title || 'Group Study Session')
            : (subjectNames[booking.subject] || booking.subject);
        
        // Calculate end time for display
        const [hour, minute] = booking.time.split(':');
        const startMinutes = parseInt(hour) * 60 + parseInt(minute);
        const endMinutes = startMinutes + parseInt(booking.duration);
        const endHour = Math.floor(endMinutes / 60);
        const endMin = endMinutes % 60;
        const endTime = formatTime(`${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`);
        const timeDisplay = booking.type === 'group' 
            ? `${formattedTime} - ${endTime}`
            : formattedTime;

        return `
            <div class="booking-item">
                <div class="booking-details">
                    <h4>${displayTitle}${booking.type === 'group' ? ' <span class="group-badge">Group</span>' : ''}</h4>
                    <p><strong>Date:</strong> ${formattedDate}</p>
                    <p><strong>Time:</strong> ${timeDisplay}</p>
                    <p><strong>Duration:</strong> ${booking.duration} minutes</p>
                    ${booking.notes ? `<p><strong>Notes:</strong> ${booking.notes}</p>` : ''}
                </div>
                <button class="booking-cancel-btn" onclick="cancelBooking('${booking.id}')">Cancel</button>
            </div>
        `;
    }).join('');
}

function formatTime(time) {
    const [hour, minute] = time.split(':');
    const h = parseInt(hour);
    const ampm = h >= 12 ? 'PM' : 'AM';
    const hour12 = h % 12 || 12;
    return `${hour12}:${minute} ${ampm}`;
}

// Make cancelBooking globally accessible
window.cancelBooking = function(bookingId) {
    if (confirm('Immersive LFA: Are you sure you want to cancel this session?')) {
        deleteBooking(bookingId);
        loadUserBookings();
        alert('Immersive LFA: Session cancelled successfully.');
    }
}

element.classList.toggle('hidden', true);

// Email sending function
async function sendBookingEmail(booking) {
    console.log('sendBookingEmail called with booking:', booking);
    console.log('Current user:', auth.currentUser);

    try {
        const subjectNames = {
            'physics': 'Physics 1',
            'other': 'Other'
        };

        const formattedDate = new Date(booking.date).toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        const formattedTime = formatTime(booking.time);

        const templateParams = {
            to_email: auth.currentUser?.email || 'user@example.com',
            to_name: auth.currentUser?.displayName || 'Student',
            subject_name: subjectNames[booking.subject] || booking.subject,
            booking_date: formattedDate,
            booking_time: formattedTime,
            booking_duration: booking.duration + ' minutes',
            booking_notes: booking.notes || 'No additional notes',
            user_email: auth.currentUser?.email || 'Not provided'
        };

        console.log('Sending email with template params:', templateParams);

        // EmailJS service configured
        const response = await emailjs.send(
            'service_mn5u6h9',     // Your EmailJS service ID
            'template_5bufvtp',    // Your EmailJS template ID
            templateParams
        );

        console.log('Email sent successfully! Response:', response);
    } catch (error) {
        console.error('Email sending failed:', error);
        console.error('Error details:', error.text || error.message || error);
        console.error('Full error object:', JSON.stringify(error, null, 2));
        alert('Immersive LFA: Booking saved, but email confirmation failed. Error: ' + (error.text || error.message || 'Unknown error'));
    }
}

// Dashboard Functions
function updateDashboard() {
    const progress = getLessonProgress();
    const totalLessons = 6; // intro, lesson1-5
    const completedLessons = Object.keys(progress).filter(key => 
        ['intro', 'lesson1', 'lesson2', 'lesson3', 'lesson4', 'lesson5'].includes(key)
    ).length;
    
    const progressPercent = Math.round((completedLessons / totalLessons) * 100);
    
    // Update progress circle
    const progressCircle = document.getElementById('progress-circle');
    const progressPercentEl = document.getElementById('progress-percent');
    const lessonsCompletedEl = document.getElementById('lessons-completed');
    
    if (progressPercentEl) {
        progressPercentEl.textContent = progressPercent + '%';
    }
    if (lessonsCompletedEl) {
        lessonsCompletedEl.textContent = `${completedLessons} of ${totalLessons} lessons completed`;
    }
    
    // Update progress ring
    const circle = document.querySelector('.progress-ring-circle');
    if (circle) {
        const circumference = 2 * Math.PI * 52;
        const offset = circumference - (progressPercent / 100) * circumference;
        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = offset;
    }
    
    // Update recent activity
    const recentActivity = document.getElementById('recent-activity');
    if (recentActivity) {
        const activities = [];
        if (completedLessons > 0) {
            activities.push(`Completed ${completedLessons} lesson${completedLessons > 1 ? 's' : ''}`);
        }
        const bookings = getUserBookings();
        if (bookings.length > 0) {
            activities.push(`Booked ${bookings.length} session${bookings.length > 1 ? 's' : ''}`);
        }
        
        if (activities.length > 0) {
            recentActivity.innerHTML = activities.map(a => `<p>${a}</p>`).join('');
        } else {
            recentActivity.innerHTML = '<p class="no-activity">No recent activity</p>';
        }
    }
    
    // Update page views
    const pageViews = parseInt(localStorage.getItem('pageViews') || '0') + 1;
    localStorage.setItem('pageViews', pageViews.toString());
    const pageViewsEl = document.getElementById('page-views');
    if (pageViewsEl) {
        pageViewsEl.textContent = pageViews;
    }
}

// Quiz Functions
const quizData = {
    'physics-basics': {
        title: 'Physics Basics Quiz',
        questions: [
            {
                question: 'What is the SI unit for length?',
                options: ['Meter', 'Kilogram', 'Second', 'Kelvin'],
                correct: 0
            },
            {
                question: 'Physics is the study of:',
                options: ['Only motion', 'Matter and energy', 'Only energy', 'Only matter'],
                correct: 1
            },
            {
                question: 'Which branch of physics deals with motion and forces?',
                options: ['Thermodynamics', 'Mechanics', 'Optics', 'Electromagnetism'],
                correct: 1
            }
        ]
    },
    'motion-quiz': {
        title: 'Motion & Kinematics Quiz',
        questions: [
            {
                question: 'What is the difference between speed and velocity?',
                options: ['Speed has direction, velocity does not', 'Velocity has direction, speed does not', 'They are the same', 'Speed is always greater'],
                correct: 1
            },
            {
                question: 'If a car accelerates from 0 to 20 m/s in 5 seconds, what is its acceleration?',
                options: ['4 m/s²', '5 m/s²', '10 m/s²', '20 m/s²'],
                correct: 0
            },
            {
                question: 'Displacement is:',
                options: ['Always equal to distance', 'A vector quantity', 'A scalar quantity', 'Always positive'],
                correct: 1
            }
        ]
    },
    'vectors-quiz': {
        title: 'Vectors & Scalars Quiz',
        questions: [
            {
                question: 'Which of the following is a scalar quantity?',
                options: ['Velocity', 'Displacement', 'Speed', 'Acceleration'],
                correct: 2
            },
            {
                question: 'A vector has:',
                options: ['Only magnitude', 'Only direction', 'Both magnitude and direction', 'Neither magnitude nor direction'],
                correct: 2
            },
            {
                question: 'If you walk 3 m east and 4 m north, your displacement is:',
                options: ['5 m', '7 m', '5 m northeast', '7 m northeast'],
                correct: 2
            }
        ]
    },
    'unit1-final': {
        title: 'Unit 1 Final Quiz',
        questions: [
            {
                question: 'What is the SI unit for mass?',
                options: ['Meter', 'Kilogram', 'Gram', 'Pound'],
                correct: 1
            },
            {
                question: 'Velocity is a:',
                options: ['Scalar', 'Vector', 'Both', 'Neither'],
                correct: 1
            },
            {
                question: 'In projectile motion, horizontal velocity is:',
                options: ['Constant', 'Increasing', 'Decreasing', 'Zero'],
                correct: 0
            },
            {
                question: 'Acceleration due to gravity on Earth is approximately:',
                options: ['9.8 m/s²', '10 m/s²', '8.9 m/s²', '9.0 m/s²'],
                correct: 0
            },
            {
                question: 'The equation v = v₀ + at is used for:',
                options: ['Constant velocity', 'Constant acceleration', 'Variable acceleration', 'No motion'],
                correct: 1
            }
        ]
    }
};

window.startQuiz = function(quizId) {
    const quiz = quizData[quizId];
    if (!quiz) return;
    
    const modal = document.getElementById('quiz-modal');
    const title = document.getElementById('quiz-title');
    const content = document.getElementById('quiz-content');
    const results = document.getElementById('quiz-results');
    
    if (!modal || !title || !content) return;
    
    title.textContent = quiz.title;
    content.style.display = 'block';
    results.style.display = 'none';
    
    let currentQuestion = 0;
    let score = 0;
    let userAnswers = [];
    
    function showQuestion() {
        if (currentQuestion >= quiz.questions.length) {
            showResults();
            return;
        }
        
        const q = quiz.questions[currentQuestion];
        content.innerHTML = `
            <div class="quiz-question">
                <p class="question-number">Question ${currentQuestion + 1} of ${quiz.questions.length}</p>
                <h3>${q.question}</h3>
                <div class="quiz-options">
                    ${q.options.map((opt, idx) => `
                        <button class="quiz-option" onclick="selectAnswer(${idx})">${opt}</button>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    window.selectAnswer = function(answerIdx) {
        userAnswers[currentQuestion] = answerIdx;
        const q = quiz.questions[currentQuestion];
        if (answerIdx === q.correct) {
            score++;
        }
        currentQuestion++;
        showQuestion();
    };
    
    function showResults() {
        content.style.display = 'none';
        results.style.display = 'block';
        const percentage = Math.round((score / quiz.questions.length) * 100);
        results.innerHTML = `
            <div class="quiz-results-content">
                <h3>Quiz Complete!</h3>
                <p class="quiz-score">Your Score: ${score}/${quiz.questions.length} (${percentage}%)</p>
                <div class="quiz-feedback">
                    ${percentage >= 80 ? '<p class="success">Excellent work!</p>' : 
                      percentage >= 60 ? '<p class="warning">Good job! Keep practicing.</p>' : 
                      '<p class="error">Review the material and try again.</p>'}
                </div>
                <button class="close-quiz-btn" onclick="closeQuiz()">Close</button>
            </div>
        `;
        
        // Save quiz score
        const userId = auth.currentUser?.uid || 'anonymous';
        const key = `quizScores_${userId}`;
        const scores = JSON.parse(localStorage.getItem(key) || '[]');
        scores.push({ quizId, score, total: quiz.questions.length, date: new Date().toISOString() });
        localStorage.setItem(key, JSON.stringify(scores));
    }
    
    modal.style.display = 'flex';
    showQuestion();
};

window.closeQuiz = function() {
    const modal = document.getElementById('quiz-modal');
    if (modal) {
        modal.style.display = 'none';
    }
};

window.joinGroupSession = function(sessionId, buttonElement) {
    // Find the group session card that was clicked
    const button = buttonElement || event?.target;
    const sessionCard = button.closest('.group-session-card');
    
    if (!sessionCard) {
        alert('Immersive LFA: Could not find session details.');
        return;
    }
    
    // Extract session details from the card
    const title = sessionCard.querySelector('h4')?.textContent || 'Group Study Session';
    const dateElement = sessionCard.querySelector('.session-date');
    
    // Get date from data-date attribute (preferred) or text content
    let sessionDate = '';
    if (dateElement) {
        sessionDate = dateElement.getAttribute('data-date') || dateElement.textContent.trim();
        // If date is formatted, try to extract YYYY-MM-DD format
        if (!sessionDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
            // Try to parse formatted date back to YYYY-MM-DD
            try {
                const parsedDate = new Date(sessionDate);
                if (!isNaN(parsedDate.getTime())) {
                    sessionDate = parsedDate.toISOString().split('T')[0];
                } else {
                    sessionDate = new Date().toISOString().split('T')[0];
                }
            } catch (e) {
                sessionDate = new Date().toISOString().split('T')[0];
            }
        }
    }
    
    // Get time text - find the paragraph containing "Time"
    const timeParagraph = Array.from(sessionCard.querySelectorAll('p')).find(p => 
        p.textContent.includes('Time:')
    );
    const timeText = timeParagraph?.textContent || '';
    
    // Parse time range (e.g., "3:00 PM - 4:30 PM")
    const timeMatch = timeText.match(/(\d{1,2}):(\d{2})\s*(AM|PM)\s*-\s*(\d{1,2}):(\d{2})\s*(AM|PM)/);
    let startTime = '';
    let duration = 90; // default 90 minutes
    
    if (timeMatch) {
        const startHour = parseInt(timeMatch[1]);
        const startMin = timeMatch[2];
        const startAmPm = timeMatch[3];
        const endHour = parseInt(timeMatch[4]);
        const endMin = timeMatch[5];
        const endAmPm = timeMatch[6];
        
        // Convert to 24-hour format for start time
        let startHour24 = startHour;
        if (startAmPm === 'PM' && startHour !== 12) startHour24 += 12;
        if (startAmPm === 'AM' && startHour === 12) startHour24 = 0;
        startTime = `${String(startHour24).padStart(2, '0')}:${startMin}`;
        
        // Calculate duration
        let endHour24 = endHour;
        if (endAmPm === 'PM' && endHour !== 12) endHour24 += 12;
        if (endAmPm === 'AM' && endHour === 12) endHour24 = 0;
        
        const startMinutes = startHour24 * 60 + parseInt(startMin);
        const endMinutes = endHour24 * 60 + parseInt(endMin);
        duration = endMinutes - startMinutes;
    } else {
        // Fallback: try to extract just start time
        const simpleTimeMatch = timeText.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/);
        if (simpleTimeMatch) {
            let hour = parseInt(simpleTimeMatch[1]);
            const min = simpleTimeMatch[2];
            const ampm = simpleTimeMatch[3];
            if (ampm === 'PM' && hour !== 12) hour += 12;
            if (ampm === 'AM' && hour === 12) hour = 0;
            startTime = `${String(hour).padStart(2, '0')}:${min}`;
        }
    }
    
    // If we still don't have a date, use a default
    if (!sessionDate) {
        sessionDate = new Date().toISOString().split('T')[0];
    }
    
    // Create booking object for group session
    const booking = {
        id: Date.now().toString(),
        type: 'group',
        title: title,
        subject: 'group-study',
        date: sessionDate,
        time: startTime || '15:00',
        duration: duration,
        sessionId: sessionId,
        createdAt: new Date().toISOString()
    };
    
    // Check if user is already registered for this session
    const existingBookings = getUserBookings();
    const alreadyJoined = existingBookings.some(b => b.sessionId === sessionId);
    
    if (alreadyJoined) {
        alert('Immersive LFA: You have already joined this group study session!');
        return;
    }
    
    // Save the booking
    saveBooking(booking);
    
    // Reload bookings list to show the new session
    loadUserBookings();
    
    alert(`Immersive LFA: You have joined the group study session "${title}"!`);
};

window.downloadFile = function(filename) {
    // Create a simple text file as a placeholder
    const content = `This is a placeholder for ${filename}. In a production environment, this would be a downloadable PDF file.`;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert(`Immersive LFA: ${filename} download started!`);
};

window.showSources = function showSources() {
    hideAllSections();
    if (sourcesSection) {
        sourcesSection.style.display = 'flex';
    }
};


// Format dates for group sessions


// Auto-scrolling testimonial ticker (Refibre-style sideways scroll, no clicks)
function initTestimonialsTicker() {
    const viewport = document.querySelector('#testimonials-ticker .ticker__viewport');
    const track = document.getElementById('testimonials-track');
    if (!viewport || !track) return;

    // Respect user accessibility settings
    const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (reduceMotion) return;

    // Snapshot the original testimonials exactly once
    if (!track.dataset.originalMarkup) {
        track.dataset.originalMarkup = track.innerHTML;
    }

    const rebuild = () => {
        track.innerHTML = track.dataset.originalMarkup;

        // Force layout so measurements are correct
        const originalWidth = track.scrollWidth;
        if (!originalWidth) return;

        const originals = Array.from(track.children);

        // Always add at least one full clone set for seamless looping
        originals.forEach(node => track.appendChild(node.cloneNode(true)));

        // Add more clones if needed to avoid seeing empty space
        const targetWidth = viewport.clientWidth + (originalWidth * 1.5);
        while (track.scrollWidth < targetWidth) {
            originals.forEach(node => track.appendChild(node.cloneNode(true)));
        }

        // Tune speed (px per second) for a smooth, premium-feeling scroll
        const pxPerSecond = 55;
        const duration = Math.max(18, Math.min(90, originalWidth / pxPerSecond));

        track.style.setProperty('--ticker-distance', `${originalWidth}px`);
        track.style.setProperty('--ticker-duration', `${duration}s`);
    };

    rebuild();

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(rebuild, 150);
    });
}


document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const sessionDates = document.querySelectorAll('.session-date');
        sessionDates.forEach(dateEl => {
            // Use data-date attribute if available, otherwise use textContent
            const dateStr = dateEl.getAttribute('data-date') || dateEl.textContent;
            if (dateStr) {
                try {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        const formatted = date.toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        dateEl.textContent = formatted;
                        // Preserve data-date attribute for later use
                        if (!dateEl.getAttribute('data-date')) {
                            dateEl.setAttribute('data-date', dateStr);
                        }
                    }
                } catch (e) {
                    // Keep original if parsing fails
                }
            }
        });
    }, 100);
});


/* ===========================
   Schoolhouse-inspired nav helpers
   =========================== */

function setActiveNav(activeId) {
    document.querySelectorAll('.sh-nav__link').forEach((btn) => {
        btn.classList.toggle('active', btn.id === activeId);
    });
}

function initSchoolhouseNav() {
    // Scroll shadow
    if (siteHeader) {
        const onScroll = () => {
            siteHeader.classList.toggle('sh-scrolled', window.scrollY > 8);
        };
        window.addEventListener('scroll', onScroll, { passive: true });
        onScroll();
    }

    // Close mobile nav when a link is clicked
    document.querySelectorAll('.sh-nav__link').forEach((btn) => {
        btn.addEventListener('click', () => closeMobileNav());
    });

    // Click outside closes menu
    document.addEventListener('click', (e) => {
        if (!siteHeader || !siteHeader.classList.contains('nav-open')) return;
        if (siteHeader.contains(e.target)) return;
        closeMobileNav();
    });

    // Default highlight
    setActiveNav('home-btn');
}

function toggleMobileNav() {
    if (!siteHeader) return;
    const isOpen = siteHeader.classList.toggle('nav-open');
    if (navToggleBtn) navToggleBtn.setAttribute('aria-expanded', String(isOpen));
}

function closeMobileNav() {
    if (!siteHeader) return;
    if (!siteHeader.classList.contains('nav-open')) return;
    siteHeader.classList.remove('nav-open');
    if (navToggleBtn) navToggleBtn.setAttribute('aria-expanded', 'false');
}

function isPreviewMode() {
    return window.__previewMode === true;
}

function setPreviewMode(on) {
    window.__previewMode = on === true;
    document.body.classList.toggle('preview-mode', window.__previewMode);

    if (previewBadge) previewBadge.hidden = !window.__previewMode;

    if (judgeTourBtn) {
        judgeTourBtn.textContent = window.__previewMode ? 'Exit preview' : 'Judge tour';
    }
}

function startOrToggleJudgeTour() {
    // If already in preview mode, turn it off and go home.
    if (isPreviewMode()) {
        setPreviewMode(false);
        showHome();
        return;
    }

    // Enable preview mode so judges can see gated pages without logging in.
    setPreviewMode(true);

    // One-click, auto-advancing tour through key sections.
    const steps = [
        () => showHome(),
        () => showLearn(),
        () => showSchedule(),
        () => showDashboard(),
        () => showResources(),
        () => {
            if (typeof showSources === 'function') showSources();
        }
    ];

    let i = 0;
    const runStep = () => {
        if (i >= steps.length) return;
        steps[i++]();
        window.setTimeout(runStep, 2800);
    };

    runStep();
}

// Settings Management Functions
function loadUserSettings() {
    const user = auth.currentUser;
    if (!user) return;

    // Load email
    const emailInput = document.getElementById('settings-email');
    if (emailInput) {
        emailInput.value = user.email || '';
    }

    // Load display name
    const displayNameInput = document.getElementById('settings-display-name');
    if (displayNameInput) {
        displayNameInput.value = user.displayName || '';
    }

    // Load preferences from localStorage
    const userId = user.uid;
    const emailNotifications = localStorage.getItem(`${userId}_emailNotifications`);
    const courseReminders = localStorage.getItem(`${userId}_courseReminders`);

    const emailNotifCheckbox = document.getElementById('email-notifications');
    if (emailNotifCheckbox && emailNotifications !== null) {
        emailNotifCheckbox.checked = emailNotifications === 'true';
    }

    const courseRemindersCheckbox = document.getElementById('course-reminders');
    if (courseRemindersCheckbox && courseReminders !== null) {
        courseRemindersCheckbox.checked = courseReminders === 'true';
    }
}

function saveUserSettings() {
    const user = auth.currentUser;
    if (!user) {
        alert('You must be logged in to save settings');
        return;
    }

    const displayNameInput = document.getElementById('settings-display-name');
    const displayName = displayNameInput ? displayNameInput.value : '';

    // Update display name in Firebase
    updateProfile(auth.currentUser, {
        displayName: displayName
    }).then(() => {
        // Save preferences to localStorage
        const userId = user.uid;
        const emailNotifCheckbox = document.getElementById('email-notifications');
        const courseRemindersCheckbox = document.getElementById('course-reminders');

        if (emailNotifCheckbox) {
            localStorage.setItem(`${userId}_emailNotifications`, emailNotifCheckbox.checked);
        }

        if (courseRemindersCheckbox) {
            localStorage.setItem(`${userId}_courseReminders`, courseRemindersCheckbox.checked);
        }

        alert('Settings saved successfully!');
    }).catch((error) => {
        console.error('Error saving settings:', error);
        alert('Failed to save settings: ' + error.message);
    });
}

function resetCourseProgress() {
    const userId = auth.currentUser?.uid || 'anonymous';

    // Clear quiz scores
    localStorage.removeItem(`quizScores_${userId}`);

    // Clear lesson progress
    const lessonProgressKey = `lessonProgress_${userId}`;
    localStorage.removeItem(lessonProgressKey);

    // Reload confidence bar
    const confidenceFill = document.getElementById('confidence-fill');
    const confidencePercentage = document.getElementById('confidence-percentage');
    const confidenceStatus = document.getElementById('confidence-status');

    if (confidenceFill) confidenceFill.style.width = '0%';
    if (confidencePercentage) confidencePercentage.textContent = '0%';
    if (confidenceStatus) {
        confidenceStatus.innerHTML = 'Complete quizzes to track confidence';
        confidenceStatus.style.color = '#4a5568';
    }

    // Reset score displays
    const midtermScore = document.getElementById('midterm-score');
    const finalScore = document.getElementById('final-score');
    if (midtermScore) midtermScore.textContent = 'Not taken';
    if (finalScore) finalScore.textContent = 'Not taken';

    alert('Your course progress has been reset successfully!');
}

async function deleteUserAccount() {
    const user = auth.currentUser;
    if (!user) {
        alert('You must be logged in to delete your account');
        return;
    }

    try {
        // Clear all user data from localStorage
        const userId = user.uid;
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.includes(userId)) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));

        // Delete the user account from Firebase
        await user.delete();

        alert('Your account has been deleted successfully. You will be redirected to the home page.');
        showHome();
    } catch (error) {
        console.error('Error deleting account:', error);
        if (error.code === 'auth/requires-recent-login') {
            alert('For security reasons, you need to log in again before deleting your account. Please log out and log back in, then try again.');
        } else {
            alert('Failed to delete account: ' + error.message);
        }
    }
}
